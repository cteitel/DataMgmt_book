# Data Structures and Importing Data {#importexport}

Some of this lesson draws from The Carpentries' [Data Organization in Spreadsheets for Ecologists](https://datacarpentry.github.io/spreadsheet-ecology-lesson) workshop, which is published under a [CC-BY 4.0](https://datacarpentry.github.io/spreadsheet-ecology-lesson/LICENSE.html) license. It is also based on materials for [WILD 6900: Tools for Reproducible Science](https://ecorepsci.github.io/reproducible-science/), Spring 2021, Utah State University, by Dr. Simona Picardi, also published under a [CC-BY 4.0](https://creativecommons.org/licenses/by/4.0/) license.

For more detail on `tidyverse` approaches to reading data, see the "Data Import" chapter of R for Data Science: https://r4ds.had.co.nz/data-import.html

## Objectives

* Work with relative file paths to read and write data
* Bring data into R from different sources and file types
* Work with text/csv files and R data objects
* Understand how to use spreadsheets for data entry and management

## Additional reading

Hadley Wickham, Mine Çetinkaya-Rundel, and Garrett Grolemund. R for Data Science (2e). Chapter 20: Spreadsheets. Available: https://r4ds.hadley.nz/spreadsheets.html

Hadley Wickham, Mine Çetinkaya-Rundel, and Garrett Grolemund. R for Data Science (2e). Chapter 7: Data import. Available: https://r4ds.hadley.nz/data-import.html

## Recap: data structures

Objects in R can come in a number of forms:

* Numbers (R differentiates between decimals - called *double* and *integers*)
* *Characters*
* *Factors* (ordered values)
* *Logical* (True/False)

They can also be combined into more complex forms:

* *Data frames*, which consist of rows and columns. Columns must have the same data type (character, integer, etc.)
* *Lists*, which can contain multiple data types. 

## File types and their interaction with R

Your computer can store any number of file types, which are usually indicated by their extension (.docx, .pdf, .csv, .xlsx, etc.). Each file type stores data differently. Some file types are **proprietary** and can only be read by certain software. It is usually best to convert these into open formats before working with them in R or other programming languages. You are likely to receive data as Excel files (.xls, .xlsx). These used to be proprietary but are now open - however, using them with R requires a little practice to know how to import data and what information is lost in the process.

## Reading .csv files into R

More often than not, you'll create data frames by importing external files (such as .csv) into R. A few useful functions for this are:

* `read.csv` and its tidy equivalent `read_csv` from the `readr` package
* `read.table`, which can read .csv and other text files (.txt, etc.)
* `source`, which reads R code files (we will get to this later)
* `read_excel` from the `readxl` package

To practice, we will use some data from an online repository: 
Murray, M. H., Sanchez, C. A., Becker, D. J., Byers, K. A., Worsley-Tonks, K. E. L., & Craft, M. E. (2020). Data from: City sicker? a meta-analysis of wildlife health and urbanization [Data set]. Zenodo. https://doi.org/10.5061/dryad.b74d971

<span style="color:red">**Navigate to the repository using the DOI to learn more about the study.**</span>

```{r, echo = T, message = F}
library(tidyverse)
```

```{r}
# First, look at the arguments for read_csv
?read_csv

# read_csv can take any file location, including a URL. Download some data:
urban_data <- read_csv("https://zenodo.org/records/3870855/files/Murray%20Sanchez%20et%20al_urban%20wildlife%20May%2020%202019.csv")

class(urban_data)
```

Notice that `read_csv` gives us information about how it read the file, including:

* the number of rows and columns
* the delimiter, which separates "cells" from one another (in this case, a comma)
* the assumed types of each column (here, 14 character columns and 28 "double", or numeric, columns)

When we examine the `class` of the new object, we see that it is a `data.frame`, but it also has other types. This is because we used a `tidyverse` package to read the data, so the object is a special type of data frame called a `tibble`. To learn more, check out `?tbl_df`.

## Writing data from R

Repositories like Zenodo should provide permanent ways to access data, but you should also save a local copy. To save this csv, we can use the `write_csv` function. 

```{r}
write_csv(urban_data, "data/raw/Murray-Sanchez_urban-wildlife.csv")
```

You should now see a new file in your raw data folder.

## Working with spreadsheets, in and out of R

Many spreadsheet programs are available. The most commonly used is Excel, so we will use Excel here, but these same principles apply to Google Sheets, etc.

```{r, fig.cap="The temptations of spreadsheets (https://xkcd.com/2180/)", fig.align='center', out.width='80%', echo = FALSE, eval = TRUE}
knitr::include_graphics("https://imgs.xkcd.com/comics/spreadsheets.png")
```

### Spreadsheets for data entry

Spreadsheets are a great tool for data entry, but to be compatible with future analyses it is important to set them up properly. One common mistake is to use spreadsheets like data sheets or lab notebooks, which include notes for context or lay out data spatially. As humans, we can (usually) interpret these things, but computers don’t view information the same way, and unless we explain to the computer what every single thing means (and that can be hard!), it will not be able to see how our data fits together. 

It is also important to know (and accept) that the best formats for data entry might not be the best formats for data analysis. In the next lesson, we will learn how to use R to automatically convert from one to another, but it is also helpful to understand the principles of data formatting in spreadsheets to make this processes as streamlined as possible. 

### Formatting data in spreadsheets

<span style="color:red">**Open the Murray, Sachez, et al. data in Excel or another spreadsheet program.**</span>

Excel may ask you if you want to covert large numbers into scientific notation. You can say yes.

Examine the spreadsheet. This is easier than looking at data using `head()` or other functions in R and RStudio. That is our first good use of spreadsheets: **familiarizing yourself with data**. 

<span style="color:red">**Discuss**</span>**: what do you notice about the structure of this dataset?**

* How are missing values represented?
* Where is there duplicated information? Why do you think it is organized this way?
* Which columns are intuitive? Which are not?
* What else is confusing or interesting about this dataset?

To answer some of these questions, we need **metadata**, which (as the name implies), is data about our data. Download the README file from the Zenodo repository: https://zenodo.org/records/3870855.

### Tidy data
This data set is *mostly* in "tidy" format, meaning that it has one observation per row and one variable per column. For example, look at the `host.class` and `aqterr` columns:

![](images/tidycolumns.png)

When entering data, you might intuitively enter it as "terrestrial mammal,", "terrestrial bird," etc., but this way data can later be filtered or analyzed by a single classification only. One case where this data set does not do this is the `host.species` column:

![](images/speciescolumn.png)

We might later be interested in grouping by genus, but we can't do that with the way the data are entered right now. We will learn how to separate the genus and species in R later.


### What to avoid

Some key practices to avoid when creating spreadsheets include:

* Multiple tables in the same sheet --> instead, use multiple tabs (sheets) in the same file (workbook) or, even better, a separate file for each table.
* Using formatting to convey information: formatting like bold, highlights, etc. can be useful for using spreadsheets, but they won't load across platforms. Instead, add a new column to flag entries.


## Exercise 2

We’re going to take a messy data set describe how we would clean it up.

* Download the [survey_data_spreadsheet_messy.xlsx](link) data and save it in your course folder.
* Open up the data in a spreadsheet program.
* You can see that there are two tabs. Two field assistants conducted the surveys, one in 2013 and one in 2014, and they both kept track of the data in their own way in tabs 2013 and 2014 of the dataset, respectively. Now you’re the person in charge of this project and you want to be able to start analyzing the data.
* Identify what is wrong with this spreadsheet and the steps you would need to take to clean up the 2013 and 2014 tabs, and to put them all together in one spreadsheet.

**Important!** Make sure you create a new file (or tab) for the cleaned data, never modify your original (raw) data. Create a README file that documents all the changes you made to get from the raw to the clean data.

<!-- Answer key -->
<!-- ##Move to single sheet -->
<!-- ##Add species as column for 2013 data -->
<!-- ##Add plot as column for 2014 data -->
<!-- ##Add column indicating scale calibration -->
<!-- ##Fix dates in plots 3 and 4 in 2014 data -->
<!-- ##All the while: no spaces in column names -->

Now, let's read the [cleaned spreadsheet](link) into R and work with it a little. (First, save this spreadsheet in in your folder for clean data):

```{r, echo = T, eval = F}
# install.packages("readxl")
library(readxl)
library(here)
library(tidyverse)

# If you are using a Windows machine, you may need to close the Excel spreadsheet before opening it with R
# Use double colons :: to indicate the source package. This can be helpful for future users.
# You can also use double colons to use a function from a package without loading it with library()
survey_data <- readxl::read_excel("data/clean/survey_data_spreadsheet_clean.xlsx", sheet = 1) 

# Alternatively, load a file using here()
survey_data <- read_excel(here("data/clean", "survey_data_spreadsheet_clean.xlsx"))

# Check the column names
names(___)

# View the first few rows
head(___)

# Summarize the dataset
summary(___)

# Get all species 
species_vect <- pull(survey_data, ___)
print(unique(species_vect)) #we can nest functions like this to save space

# Get the mean weight of all samples
mean(___) 
#You might get a surprise answer here! Use the help function to find out how to fix this:
?mean 
mean(___, ___)

```

### Exercise 2 Questions

1. NA appears twice in the species vector. Why is this? Would you change anything in the data spreadsheet to avoid this, or is it not a problem?
2. What values in the spreadsheet are interpreted by R as missing values? How would you account for this in data entry?
